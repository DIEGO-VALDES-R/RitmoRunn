<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunnersPace Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: hsl(66, 88%, 49%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 100%;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        h1, h3 {
            text-align: center;
            color: #05233b;
        }

        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 20px;
            box-sizing: border-box;
            text-align: center;
            font-size: 16px;
        }

        input[name="nombreCarrera"] {
            width: 80%;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
            text-align: center;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .button-group button {
            flex: 1 1 calc(50% - 5px);
            max-width: none;
        }

        button {
            background-color: #112075;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
        }

        button:hover {
            background-color: #f7a01f;
        }

        button.active {
            background-color: #1de40a;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
        }

        #feedback {
            margin-top: 20px;
            font-weight: bold;
            max-width: none;
            width: 100%;
        }

        .achieved {
            color: #4CAF50;
        }

        .not-achieved {
            color: #F44336;
        }

        #carrerasGuardadas {
            display: none;
        }

        .carrera-guardada {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }

        .carrera-guardada button {
            width: auto;
            padding: 8px 15px;
            margin: 5px;
            font-size: 14px;
        }

        #creator-info, footer {
            background-color: #112075;
            color: white;
            padding: 10px 0;
            text-align: center;
            font-size: 0.9em;
            width: 100%;
        }

        #photoContainer {
            margin-top: 20px;
            text-align: center;
        }

        #photoContainer img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .center-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        #datosCarreraContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            box-sizing: border-box;
        }

        .datos-carrera-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 50px;
            margin-bottom: 20px;
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        .dato-carrera {
            border: 1px solid #ddd;
            padding: 37px; /* Reducido a la mitad */
            width: calc(50% - 1.5px);
            text-align: center;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-sizing: border-box;
            min-height: 35px; /* Reducido a la mitad */
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 16px;
        }

        .label {
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .dato-carrera {
                width: 70%;
                min-height: 35px; /* Reducido a la mitad */
            }
        }

        /* A√±ade esto para hacer que el texto dentro de los contenedores sea m√°s grande */
        .dato-carrera div:not(.label) {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="creator-info">Desarrollada por Diego Vald√©s</div>
    <div class="container">
        <h1>RunnersPace Pro</h1>
        <div class="center-container">
            <button id="ingresarDatosBtn">Ingresa datos de tu carrera</button>
        </div>
        <div id="datosCarreraContainer" style="display: none;">
            <label for="nombreCarrera">Nombre de la carrera</label>
            <input type="text" id="nombreCarreraInput" placeholder="Nombre de la carrera">
            <label for="distanciaObjetivo">Distancia objetivo (km)</label>
            <input type="number" id="distanciaObjetivoInput" placeholder="Distancia objetivo (km)" value="0">
            <label for="tiempoObjetivo" style="text-align: center; width: 100%;">Tiempo Objetivo</label>
            <div class="time-input">
                <div>
                    <label for="tiempoObjetivoHoras">(horas)</label>
                    <input type="number" id="tiempoObjetivoHoras" placeholder="Horas" value="0">
                </div>
                <div>
                    <label for="tiempoObjetivoMinutos">(minutos)</label>
                    <input type="number" id="tiempoObjetivoMinutos" placeholder="Minutos" value="0">
                </div>
            </div>
           
            <button id="guardarDatosBtn" pnclick="guardarDatosBtn">Guardar</button>
        </div>
        <div class="datos-carrera-container">
            <div>
                <div class="label">Nombre</div>
                <div class="dato-carrera" id="nombreCarrera"></div>
            </div>
            <div>
                <div class="label">Distancia Objetivo</div>
                <div class="dato-carrera" id="distanciaObjetivo"></div>
            </div>
            <div>
                <div class="label">Tiempo Objetivo</div>
                <div class="dato-carrera" id="tiempoObjetivo"></div>
            </div>
            <div>
                <div class="label">Ritmo Objetivo</div>
                <div class="dato-carrera" id="ritmoObjetivoValor"></div>
            </div>
        </div>
    </div>
    <div id="datosGuardados" class="card" style="display: none;"></div>
    <div class="button-group">
        <div id="feedback" class="card"></div>
        <div class="card">
            <div class="button-group">
                <button id="iniciarBtn" onclick="iniciarCarrera()">Iniciar Carrera</button>
                <button id="pausarBtn" onclick="pausarReanudarCarrera()">Pausar Carrera</button>
                <button onclick="finalizarCarrera()">Finalizar Carrera</button>
                <button onclick="nuevaCarrera()">Nueva Carrera</button>
            </div>
        </div>
        <div class="button-group">
           
            <button onclick="toggleCarrerasGuardadas()">Ver Carreras Guardadas</button>
        </div>
        <button onclick="prepararYExportarGPX()">Exportar GPX</button>
    </div>
    <div id="map"></div>
    <div id="photoContainer"></div>
    <div id="carrerasGuardadas" class="card" style="display: none;"></div>
    <div id="counter" style="display: none;"></div>
    <footer>
        Desarrollado por Diego Vald√©s
    </footer>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNoJAfM3yuVwAcmXoJ2z8whnG2-2TJPpM&libraries=geometry&callback=initMap" async></script>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ingresarDatosBtn = document.getElementById('ingresarDatosBtn');
    const datosCarreraContainer = document.getElementById('datosCarreraContainer');
    const guardarDatosBtn = document.getElementById('guardarDatosBtn');
    const nombreCarreraInput = document.getElementById('nombreCarreraInput');
    const distanciaObjetivoInput = document.getElementById('distanciaObjetivoInput');
    const tiempoObjetivoHoras = document.getElementById('tiempoObjetivoHoras');
    const tiempoObjetivoMinutos = document.getElementById('tiempoObjetivoMinutos');
    const nombreCarrera = document.getElementById('nombreCarrera');
    const distanciaObjetivo = document.getElementById('distanciaObjetivo');
    const tiempoObjetivo = document.getElementById('tiempoObjetivo');
    const ritmoObjetivoValor = document.getElementById('ritmoObjetivoValor');

    ingresarDatosBtn.addEventListener('click', () => {
        datosCarreraContainer.style.display = 'block';
    });

    guardarDatosBtn.addEventListener('click', () => {
        const ritmo = calcularRitmo();
        if (ritmo !== null) {
            nombreCarrera.textContent = nombreCarreraInput.value;
            distanciaObjetivo.textContent = `${distanciaObjetivoInput.value} km`;
            tiempoObjetivo.textContent = `${tiempoObjetivoHoras.value} h ${tiempoObjetivoMinutos.value} min`;
            ritmoObjetivoValor.textContent = ritmo;
            datosCarreraContainer.style.display = 'none';
        }
    });

    function calcularRitmo() {
        const distancia = parseFloat(distanciaObjetivoInput.value);
        const horas = parseFloat(tiempoObjetivoHoras.value);
        const minutos = parseFloat(tiempoObjetivoMinutos.value);

        if (isNaN(distancia) || isNaN(horas) || isNaN(minutos)) {
            alert('Por favor, ingrese valores v√°lidos para la distancia y el tiempo.');
            return null; // Retorna null si hay alg√∫n error
        }

        const tiempoTotalMinutos = horas * 60 + minutos;
        if (tiempoTotalMinutos === 0) {
            alert('El tiempo total no puede ser cero.');
            return null; // Retorna null si el tiempo es cero
        }

        const ritmo = tiempoTotalMinutos / distancia;
        return ritmo.toFixed(2); // Devuelve el ritmo calculado
    }
});


function calcularRitmo() {
    const distancia = parseFloat(distanciaObjetivoInput.value);
    const horas = parseFloat(tiempoObjetivoHoras.value);
    const minutos = parseFloat(tiempoObjetivoMinutos.value);

    if (isNaN(distancia) || isNaN(horas) || isNaN(minutos)) {
        alert('Por favor, ingrese valores v√°lidos para la distancia y el tiempo.');
        return null; // Retorna null si hay alg√∫n error
    }

    const tiempoTotalMinutos = horas * 60 + minutos;
    if (tiempoTotalMinutos === 0) {
        alert('El tiempo total no puede ser cero.');
        return null; // Retorna null si el tiempo es cero
    }

    const ritmo = tiempoTotalMinutos / distancia;
    return ritmo.toFixed(2); // Devuelve el ritmo calculado
}

        let map, marker, path;
        let startTime, endTime, timerInterval;
        let distanciaRecorrida = 0;
        let watchID;
        let isPaused = false;
        let pausedTime, pausedDuration = 0;
        let kmMarkers = [];
        let caloriasQuemadas = 0;
        const CALORIAS_POR_KM = 60;
        let speechSynthesis = window.speechSynthesis;
        let utterance;
        let ritmoAlcanzado = true;
        let intervalID;
        let foto;
        let carreraGuardada = false;
        let distanciaObjetivo = 0;
        let objetivoAlcanzado = false;
        let distanciaHastaProximoKm = 1.0;
        let kilometrosRecorridos = 0;
        let elevationData = [];
        let isRunning = false;
        let timer;
        let totalTime = 0;
        let watchId;
        let route = [];
        let totalCalories = 0;
        let weight = 70; // Default weight
        let height = 170; // Default height
        let carrerasGuardadas = JSON.parse(localStorage.getItem("carrerasGuardadas")) || [];
        let ritmoObjetivo = '';

                function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 15,
            });
            marker = new google.maps.Marker({
                map: map,
                title: 'Tu ubicaci√≥n actual',
            });
            path = new google.maps.Polyline({
                map: map,
                path: [],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
            });
        }

        document.getElementById('ingresarDatosBtn').addEventListener('click', function() {
            document.getElementById('datosCarreraContainer').style.display = 'block';
        });

        document.getElementById('guardarDatosBtn').addEventListener('click', function() {
            const nombreCarrera = document.getElementById('nombreCarrera').value;
            const distanciaObjetivo = document.getElementById('distanciaObjetivo').value;
            const tiempoObjetivoHoras = document.getElementById('tiempoObjetivoHoras').value;
            const tiempoObjetivoMinutos = document.getElementById('tiempoObjetivoMinutos').value;
            const ritmoObjetivo = document.getElementById('ritmoObjetivo').innerText;

            const datosGuardados = `
                <h3>Datos de la carrera:</h3>
                <p>Nombre: ${nombreCarrera}</p>
                <p>Distancia objetivo: ${distanciaObjetivo} km</p>
                <p>Tiempo objetivo: ${tiempoObjetivoHoras}h ${tiempoObjetivoMinutos}m</p>
                <p>${ritmoObjetivo}</p>
            `;

            document.getElementById('datosGuardados').innerHTML = datosGuardados;
            document.getElementById('datosGuardados').style.display = 'block';
            document.getElementById('datosCarreraContainer').style.display = 'none';
        });

function startRunning() {
    if (!isRunning) {
        isRunning = true;
        startTime = new Date();
        if (isPaused) {
            pausedDuration += new Date() - pausedTime;
        }
        isPaused = false;
        document.getElementById('pausarBtn').classList.remove('active');
        document.getElementById('iniciarBtn').classList.add('active');
        watchID = navigator.geolocation.watchPosition(updateLocation, handleError, {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 5000,
        });
        intervalID = setInterval(updateFeedback, 1000);
    }
}

function iniciarCarrera() {
    if (navigator.geolocation) {
        if (!isPaused) {
            startTime = new Date();
            distanciaRecorrida = 0;
            caloriasQuemadas = 0;
            pausedDuration = 0;
            document.getElementById('feedback').innerHTML = "";
            path.setPath([]);
            elevationData = [];
        } else {
            // Si estaba pausado, ajustamos el tiempo de inicio
            startTime = new Date(new Date() - (pausedTime - startTime) - pausedDuration);
        }
        isPaused = false;
        watchID = navigator.geolocation.watchPosition(updateLocation, handleError, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
        });
        timerInterval = setInterval(updateFeedback, 1000);
        intervalID = setInterval(checkRitmo, 30000);
        document.getElementById('iniciarBtn').classList.add('active');
        document.getElementById('pausarBtn').classList.remove('active');
        document.getElementById('pausarBtn').textContent = 'Pausar Carrera';
        isRunning = true;
        carreraGuardada = false;
    } else {
        alert("La geolocalizaci√≥n no es soportada por este navegador.");
    }
}

function pausarReanudarCarrera() {
    if (!isPaused) {
        clearInterval(timerInterval);
        clearInterval(intervalID);
        if (navigator.geolocation) {
            navigator.geolocation.clearWatch(watchID);
        }
        pausedTime = new Date();
        isPaused = true;
        document.getElementById('pausarBtn').textContent = 'Reanudar Carrera';
        document.getElementById('pausarBtn').classList.add('active');
        document.getElementById('iniciarBtn').classList.remove('active');
        isRunning = false;
    } else {
        iniciarCarrera();
    }
}

        function finalizarCarrera() {
    if (!isRunning) {
        console.log("La carrera no est√° en curso.");
        return;
    }
    
    console.log("Finalizando carrera...");
    
    endTime = new Date();
    clearInterval(timerInterval);
    clearInterval(intervalID);
    
    if (navigator.geolocation) {
        navigator.geolocation.clearWatch(watchID);
    }
    
    isRunning = false;
    
    mostrarResultados();
    
    const ritmoObjetivo = parseFloat(document.getElementById('ritmoObjetivoValor').textContent);
    const ritmoFinal = calcularRitmoPromedio();
    
    if (ritmoFinal <= ritmoObjetivo) {
        mostrarMensaje(`¬°Felicidades! Alcanzaste tu ritmo objetivo. Ritmo Final: ${ritmoFinal.toFixed(2)} min/km.`, 'achieved');
    } else {
        mostrarMensaje(`No alcanzaste tu ritmo objetivo. Ritmo Final: ${ritmoFinal.toFixed(2)} min/km.`, 'not-achieved');
    }
    
    console.log("Carrera finalizada.");
    
    document.getElementById('iniciarBtn').classList.remove('active');
    document.getElementById('pausarBtn').classList.remove('active');
}

function nuevaCarrera() {
            if (!carreraGuardada) {
                if (confirm("¬øQuieres guardar la carrera antes de borrarla?")) {
                    guardarCarrera();
                } else {
                    resetearCarrera();
                }
            } else {
                resetearCarrera();
            }
        }

        function resetearCarrera() {
            document.getElementById('feedback').innerHTML = "";
            document.getElementById('ritmoObjetivo').innerHTML = "";
            document.getElementById('distanciaObjetivo').value = "0";
            document.getElementById('tiempoObjetivoHoras').value = "0";
            document.getElementById('tiempoObjetivoMinutos').value = "0";
            document.getElementById('nombreCarrera').value = "";
            objetivoAlcanzado = false;
            distanciaRecorrida = 0;
            path.setPath([]);
            elevationData = [];
            clearInterval(timerInterval);
            clearInterval(intervalID);
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watchID);
            }
            distanciaRecorrida = 0;
            caloriasQuemadas = 0;
            isPaused = false;
            pausedDuration = 0;
            kmMarkers = [];
            document.getElementById('iniciarBtn').classList.remove('active');
            document.getElementById('pausarBtn').classList.remove('active');
            document.getElementById('pausarBtn').textContent = 'Pausar Carrera';
            carreraGuardada = false;
            isRunning = false;
        }

        function actualizarDistancia(nuevaDistancia) {
            distanciaRecorrida += nuevaDistancia;
        
            if (!objetivoAlcanzado && distanciaRecorrida >= distanciaObjetivo) {
                objetivoAlcanzado = true;
                const utterance = new SpeechSynthesisUtterance(`Has completado tu distancia objetivo de ${distanciaObjetivo} kil√≥metros.`);
                speechSynthesis.speak(utterance);
            }
        }

        function updateLocation(position) {
            const { latitude, longitude } = position.coords;
            const currentLocation = new google.maps.LatLng(latitude, longitude);
            path.getPath().push(currentLocation);
            map.panTo(currentLocation);
            marker.setPosition(currentLocation);
            if (path.getPath().getLength() > 1) {
                const previousLocation = path.getPath().getAt(path.getPath().getLength() - 2);
                const newDistance = google.maps.geometry.spherical.computeDistanceBetween(previousLocation, currentLocation) / 1000;
                distanciaRecorrida += newDistance;
                caloriasQuemadas = distanciaRecorrida * CALORIAS_POR_KM;
            }
            // Simular datos de elevaci√≥n (reemplazar con datos reales si est√°n disponibles)
            elevationData.push(Math.random() * 100);
            checkKmMarkers(currentLocation);
        }

        function checkKmMarkers(currentLocation) {
            const kmMark = Math.floor(distanciaRecorrida);
            if (kmMarkers.length < kmMark) {
                kmMarkers.push(currentLocation);
                utterance = new SpeechSynthesisUtterance(`¬°Has completado ${kmMark} kil√≥metros!`);
                speechSynthesis.speak(utterance);
}
        }

        function handleError(error) {
            console.error(`Error: ${error.message}`);
        }

        function updateFeedback() {
    const now = new Date();
    const elapsedTime = now - startTime - pausedDuration;
    const hours = Math.floor(elapsedTime / 3600000);
    const minutes = Math.floor((elapsedTime % 3600000) / 60000);
    const seconds = Math.floor((elapsedTime % 60000) / 1000);
    const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('feedback').innerHTML = `Distancia: ${distanciaRecorrida.toFixed(2)} km<br> Tiempo: ${formattedTime}<br> Calor√≠as: ${caloriasQuemadas.toFixed(2)} kcal<br> Ritmo Actual: ${calcularRitmoPromedio().toFixed(2)} min/km`;
}

        function calcularRitmoObjetivo() {
    const tiempoObjetivoHoras = parseFloat(document.getElementById('tiempoObjetivoHoras').value) || 0;
    const tiempoObjetivoMinutos = parseFloat(document.getElementById('tiempoObjetivoMinutos').value) || 0;
    const distanciaObjetivo = parseFloat(document.getElementById('distanciaObjetivoInput').value) || 0;

    if (distanciaObjetivo === 0) {
        alert('La distancia objetivo no puede ser 0.');
        return;
    }

    const tiempoObjetivoMinutosTotales = (tiempoObjetivoHoras * 60) + tiempoObjetivoMinutos;
    const ritmoObjetivo = (tiempoObjetivoMinutosTotales / distanciaObjetivo).toFixed(2); // ritmo en minutos por km

    document.getElementById('ritmoObjetivoValor').textContent = ritmoObjetivo;

    alert(`El ritmo objetivo es ${ritmoObjetivo} min/km`);
}

        function calcularRitmoPromedio() {
            const elapsedTime = (new Date() - startTime - pausedDuration) / 1000 / 60; // Convertir a minutos
            return distanciaRecorrida > 0 ? elapsedTime / distanciaRecorrida : 0;
        }

        function mostrarResultados() {
            const elapsedTime = new Date(new Date() - startTime - pausedDuration);
            const hours = elapsedTime.getUTCHours();
            const minutes = elapsedTime.getUTCMinutes();
            const seconds = elapsedTime.getUTCSeconds();
            const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('feedback').innerHTML = `Distancia: ${distanciaRecorrida.toFixed(2)} km<br> Tiempo: ${formattedTime}<br> Calor√≠as: ${caloriasQuemadas.toFixed(2)} kcal<br> Ritmo Promedio: ${calcularRitmoPromedio().toFixed(2)} min/km`;
        }

        function checkRitmo() {
            const ritmoObjetivo = calcularRitmoObjetivo();
            const ritmoPromedio = calcularRitmoPromedio();
            if (ritmoPromedio <= ritmoObjetivo) {
                utterance = new SpeechSynthesisUtterance(`¬°Excelente ritmo, mant√©nte as√≠ y lograr√°s tu objetivo! Ritmo actual: ${ritmoPromedio.toFixed(2)} minutos por kil√≥metro`);
                speechSynthesis.speak(utterance);
            } else {
                utterance = new SpeechSynthesisUtterance(`¬°Corre un poco m√°s r√°pido, si sigues as√≠ no lograr√°s tu objetivo! Ritmo actual: ${ritmoPromedio.toFixed(2)} minutos por kil√≥metro`);
                speechSynthesis.speak(utterance);
                ritmoAlcanzado = false;
            }
        }

        function mostrarMensaje(mensaje, clase) {
            document.getElementById('feedback').innerHTML += `<div class="${clase}">${mensaje}</div>`;
        }

        function finalizarCarrera() {
    if (!isRunning) {
        console.log("La carrera no est√° en curso.");
        return;
    }
    
    console.log("Finalizando carrera...");
    
    endTime = new Date();
    clearInterval(timerInterval);
    clearInterval(intervalID);
    
    if (navigator.geolocation) {
        navigator.geolocation.clearWatch(watchID);
    }
    
    isRunning = false;
    
    const tiempoFinal = endTime - startTime - pausedDuration;
    
    mostrarResultados(tiempoFinal);
    
    const ritmoObjetivo = parseFloat(document.getElementById('ritmoObjetivoValor').textContent);
    const ritmoFinal = calcularRitmoPromedio();
    
    if (ritmoFinal <= ritmoObjetivo) {
        mostrarMensaje(`¬°Felicidades! Alcanzaste tu ritmo objetivo. Ritmo Final: ${ritmoFinal.toFixed(2)} min/km.`, 'achieved');
    } else {
        mostrarMensaje(`No alcanzaste tu ritmo objetivo. Ritmo Final: ${ritmoFinal.toFixed(2)} min/km.`, 'not-achieved');
    }
    
    console.log("Carrera finalizada.");
    
    document.getElementById('iniciarBtn').classList.remove('active');
    document.getElementById('pausarBtn').classList.remove('active');

    // Guardar la carrera con el tiempo final correcto
    guardarCarrera(tiempoFinal);
}

function guardarCarrera(tiempoFinal) {
    if (path && path.getPath().getLength() > 0) {
        const ritmoObjetivo = document.getElementById('ritmoObjetivoValor').textContent;

        const carrera = {
            nombre: document.getElementById('nombreCarrera').textContent,
            fecha: new Date().toISOString().split('T')[0],
            distancia: distanciaRecorrida.toFixed(2),
            tiempo: tiempoFinal,
            calorias: caloriasQuemadas,
            ritmoPromedio: calcularRitmoPromedio().toFixed(2),
            ritmoObjetivo: ritmoObjetivo,
            ruta: path.getPath().getArray(),
            elevacion: elevationData
        };

        let carrerasGuardadas = JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
        carrerasGuardadas.push(carrera);
        localStorage.setItem('carrerasGuardadas', JSON.stringify(carrerasGuardadas));

        alert('Carrera guardada con √©xito');
    } else {
        alert('No hay datos de carrera para guardar');
    }
}

function mostrarCarrerasGuardadas() {
    const carrerasGuardadas = JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
    const container = document.getElementById('carrerasGuardadas');
    container.innerHTML = '';

    if (carrerasGuardadas.length === 0) {
        container.innerHTML = '<p>No hay carreras guardadas.</p>';
        return;
    }

    carrerasGuardadas.forEach((carrera, index) => {
        const carreraElement = document.createElement('div');
        carreraElement.className = 'carrera-guardada';
        carreraElement.innerHTML = `
            <h3>${carrera.nombre}</h3>
            <p>Fecha: ${carrera.fecha}</p>
            <p>Distancia: ${carrera.distancia} km</p>
            <p>Tiempo: ${formatTime(carrera.tiempo)}</p>
            <p>Ritmo Promedio: ${carrera.ritmoPromedio} min/km</p>
            <p>Ritmo Objetivo: ${carrera.ritmoObjetivo} min/km</p> <!-- Mostrar ritmo objetivo -->
            <button onclick="prepararYExportarGPX(${index})">Exportar GPX</button>
            <button onclick="eliminarCarrera(${index})">Eliminar</button>
            <button onclick="compartirCarrera(${index})">Compartir</button>
        `;
        container.appendChild(carreraElement);
    });
}

        function formatTime(ms) {
    const date = new Date(ms);
    return `${date.getUTCHours()}:${date.getUTCMinutes().toString().padStart(2, '0')}:${date.getUTCSeconds().toString().padStart(2, '0')}`;
}

function eliminarCarrera(index) {
    const carrerasGuardadas = JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
    carrerasGuardadas.splice(index, 1);
    localStorage.setItem('carrerasGuardadas', JSON.stringify(carrerasGuardadas));
    mostrarCarrerasGuardadas();
}

function toggleCarrerasGuardadas() {
    var container = document.getElementById("carrerasGuardadas");
    container.style.display = container.style.display === "none" ? "block" : "none";
    if (container.style.display === "block") {
        mostrarCarrerasGuardadas();
    }
}

function getCarrerasGuardadas() {
  try {
    return JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
  } catch (error) {
    console.error('Error al acceder a localStorage:', error);
    return [];
  }
}

function prepararYExportarGPX(index) {
    const carrerasGuardadas = JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
    const carrera = carrerasGuardadas[index];

    if (carrera.ruta.length === 0) {
        alert("No hay datos de ruta para exportar.");
        return;
    }

    const data = {
        nombreCarrera: carrera.nombre,
        path: new google.maps.MVCArray(carrera.ruta.map(coord => new google.maps.LatLng(coord.lat, coord.lng))),
        elevationData: carrera.elevacion
    };
    exportarGPX(data);
}

function exportarGPX(data) {
    const { nombreCarrera, path, elevationData } = data;

    if (!nombreCarrera || !path || !elevationData) {
        console.error('Error: Datos de entrada incompletos.');
        return;
    }

    if (path.getLength() === 0) {
        console.error('Error: No hay datos de ruta.');
        return;
    }

    if (elevationData.length !== path.getLength()) {
        console.error('Error: Datos de elevaci√≥n incorrectos.');
        return;
    }

    const startTime = new Date();
    const timeIntervalPerPoint = 30; // segundos

    let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="RunnersPace Pro" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <time>${startTime.toISOString()}</time>
  </metadata>
  <trk>
    <name>${escapeXml(nombreCarrera)}</name>
    <type>Running</type>
    <trkseg>
`;

    const pathArray = path.getArray();
    let distanceSoFar = 0;

    for (let i = 0; i < pathArray.length; i++) {
        const point = pathArray[i];
        
        if (i > 0) {
            try {
                distanceSoFar += google.maps.geometry.spherical.computeDistanceBetween(pathArray[i-1], point);
            } catch (error) {
                console.warn('Error al calcular distancia:', error);
            }
        }

        const elevation = elevationData[i] || 0;
        const pointTime = new Date(startTime.getTime() + i * timeIntervalPerPoint * 1000);

        gpxContent += `    <trkpt lat="${point.lat()}" lon="${point.lng()}">
      <ele>${elevation.toFixed(1)}</ele>
      <time>${pointTime.toISOString()}</time>
    </trkpt>
`;
    }

    gpxContent += `  </trkseg>
  </trk>
</gpx>`;

    try {
        const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${nombreCarrera.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.gpx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error al exportar archivo GPX:', error);
        alert('Error al exportar archivo GPX. Intenta nuevamente.');
    }
}

function escapeXml(unsafe) {
    return unsafe.replace(/[<>&'"]/g, function (c) {
        switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case "'": return '&apos;';
            case '"': return '&quot;';
        }
    });
}

function compartirCarrera(index) {
    const carrerasGuardadas = JSON.parse(localStorage.getItem('carrerasGuardadas')) || [];
    const carrera = carrerasGuardadas[index];

    const mensaje = `
        üèÉ‚Äç‚ôÇÔ∏è Carrera: ${carrera.nombre}
        üìÖ Fecha: ${carrera.fecha}
        üìè Distancia: ${carrera.distancia} km
        ‚è±Ô∏è Tiempo: ${formatTime(carrera.tiempo)}
        üèÉ‚Äç‚ôÇÔ∏è Ritmo Promedio: ${carrera.ritmoPromedio} min/km
        üî• Calor√≠as: ${carrera.calorias}
    `;
    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;

    window.open(url, '_blank');
}

function tomarFoto() {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(mediaStream => {
            const video = document.createElement('video');
            video.style.display = 'none';
            document.body.appendChild(video);
            video.srcObject = mediaStream;
            video.play();

            video.onloadedmetadata = () => {
                const button = document.createElement('button');
                button.textContent = 'Capturar Foto';
                button.style.display = 'block';
                document.body.appendChild(button);

                button.addEventListener('click', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const photoContainer = document.getElementById('photoContainer');
                    photoContainer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg');
                    photoContainer.appendChild(img);

                    video.pause();
                    video.srcObject.getTracks().forEach(track => track.stop());
                    document.body.removeChild(video);
                    document.body.removeChild(button);
                });
            };
        })
        .catch(error => {
            console.error('Error al acceder a la c√°mara:', error);
        });
}

        // Funci√≥n para mostrar ritmos por kil√≥metro (a implementar)
        function mostrarRitmosPorKm() {
    // Simulamos datos de ejemplo
    const ritmosPorKm = [
        { km: 1, ritmo: '5:00' },
        { km: 2, ritmo: '4:55' },
        { km: 3, ritmo: '5:10' },
        // Agregar m√°s datos seg√∫n sea necesario
    ];

    let mensaje = 'Ritmos por kil√≥metro:\n';
    ritmosPorKm.forEach(dato => {
        mensaje += `Kil√≥metro ${dato.km}: ${dato.ritmo}\n`;
    });

    alert(mensaje);
}

    </script>
</body>
</html>
