<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunnersPace Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: hsl(66, 88%, 49%);
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            text-align: center;
            color: #05233b;
        }
        .card {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 10px;
            margin-bottom: 20px;
        }
        input, button {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
        }
        .button-group button {
            width: 48%;
        }
        .time-input {
            display: flex;
            justify-content: space-between;
        }
        .time-input input {
            width: 48%;
        }
        button {
            background-color: #112075;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #f7a01f;
        }
        button.active {
            background-color: #1de40a;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
        }
        #feedback {
            margin-top: 20px;
            font-weight: bold;
        }
        .achieved {
            color: #4CAF50;
        }
        .not-achieved {
            color: #F44336;
        }
        #carrerasGuardadas {
            display: none;
        }
        .carrera-guardada {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .carrera-guardada button {
            width: auto;
            padding: 5px 10px;
            margin: 5px;
        }
        footer {
            text-align: center;
            margin: 10px auto 0;
            padding: 0,5px;
            background-color: #112075;
            color: white;
            border-radius: 20px;
            font-size: 1em;
            max-width: 90%;
        }
        #creator-info {
            position: static;
            background-color: #112075;
            color: white;
            padding: 5px 0;
            text-align: center;
            font-size: 0.8em;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="creator-info">Desarrollada por Diego Valdés</div>
    <div class="container">
        <h1>Alcanza tu ritmo</h1>
        <div class="card">
            <input type="text" id="nombreCarrera" placeholder="Nombre de la carrera">
            <h3>Distancia objetivo km</h3>
            <input type="number" id="distanciaObjetivo" placeholder="Distancia objetivo (km)" value="0">
            <h3>Tiempo Objetivo Horas - Min</h3>
            <div class="time-input">
                <input type="number" id="tiempoObjetivoHoras" placeholder="Tiempo objetivo (horas)" value="0">
                <input type="number" id="tiempoObjetivoMinutos" placeholder="Tiempo objetivo (minutos)" value="0">
            </div>
            <button onclick="calcularRitmo()">Calcular Ritmo</button>
            <div id="ritmoObjetivo"></div>
            <div id="feedbackInicio"></div>
        </div>
        <div class="card">
            <div class="button-group">
                <button id="iniciarBtn" onclick="iniciarCarrera()">Iniciar Carrera</button>
                <button id="pausarBtn" onclick="pausarReanudarCarrera()">Pausar Carrera</button>
            </div>
            <div class="button-group">
                <button onclick="finalizarCarrera()">Finalizar Carrera</button>
                <button onclick="nuevaCarrera()">Nueva Carrera</button>
            </div>
        </div>
        <div id="feedback" class="card"></div>
        <div class="card">
            <div class="button-group">
                <button onclick="mostrarRitmosPorKm()">Analizar Ritmos</button>
                <button onclick="exportarGPX()">Exportar Ruta GPX</button>
            </div>
            <div class="button-group">
                <button onclick="guardarCarrera()">Guardar Carrera</button>
                <button onclick="toggleCarrerasGuardadas()">Mostrar/Ocultar Carreras Guardadas</button>
            </div>
            <button onclick="tomarFoto()">Tomar Foto</button>
        </div>
        <div id="carrerasGuardadas" class="card"></div>
        <div id="map"></div>
        <footer>
            <p>Versión de Prueba</p>
        </footer>
    </div>
    <script>
        let map, marker, path;
        let startTime, endTime, timerInterval;
        let distanciaRecorrida = 0;
        let watchID;
        let isPaused = false;
        let pausedTime, pausedDuration = 0;
        let kmMarkers = [];
        let caloriasQuemadas = 0;
        const CALORIAS_POR_KM = 60;
        let speechSynthesis = window.speechSynthesis;
        let utterance;
        let ritmoAlcanzado = true;
        let intervalID;
        let foto;
        let carreraGuardada = false;

        function initMap() {
            map = L.map('map').setView([0, 0], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            marker = L.marker([0, 0]).addTo(map);
            path = L.polyline([], {color: 'red'}).addTo(map);
        }

                document.addEventListener('DOMContentLoaded', initMap);

        function startCountdown() {
            const counterElement = document.getElementById('counter');
            let counter = 5;
            counterElement.style.display = 'flex';
            counterElement.textContent = counter;
            const countdownInterval = setInterval(() => {
                counter--;
                if (counter === 0) {
                    clearInterval(countdownInterval);
                    counterElement.style.display = 'none';
                    startRunning();
                    speak("Inicia la carrera");
                } else {
                    counterElement.textContent = counter;
                }
            }, 1000);
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(msg);
        }

        function startRunning() {
            if (!isRunning) {
                isRunning = true;
                startTime = new Date();
                if (isPaused) {
                    pausedDuration += new Date() - pausedTime;
                }
                isPaused = false;
                document.getElementById('pausarBtn').classList.remove('active');
                document.getElementById('iniciarBtn').classList.add('active');
                watchID = navigator.geolocation.watchPosition(updateLocation, handleError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000,
                });
                intervalID = setInterval(updateFeedback, 1000);
            }
        }

        function iniciarCarrera() {
            if (navigator.geolocation) {
                if (!isPaused) {
                    startTime = new Date();
                    distanciaRecorrida = 0;
                    caloriasQuemadas = 0;
                    pausedDuration = 0;
                    document.getElementById('feedback').innerHTML = "";
                } else {
                    pausedDuration += (new Date() - pausedTime);
                }
                isPaused = false;
                watchID = navigator.geolocation.watchPosition(updateLocation, handleError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0,
                });
                timerInterval = setInterval(updateFeedback, 1000);
                intervalID = setInterval(checkRitmo, 30000);
                document.getElementById('iniciarBtn').classList.add('active');
                document.getElementById('pausarBtn').classList.remove('active');
                document.getElementById('pausarBtn').textContent = 'Pausar Carrera';
            } else {
                alert("La geolocalización no es soportada por este navegador.");
            }
        }

        function pausarReanudarCarrera() {
            if (!isPaused) {
                clearInterval(timerInterval);
                clearInterval(intervalID);
                if (navigator.geolocation) {
                    navigator.geolocation.clearWatch(watchID);
                }
                pausedTime = new Date();
                isPaused = true;
                document.getElementById('pausarBtn').textContent = 'Reanudar Carrera';
                document.getElementById('pausarBtn').classList.add('active');
                document.getElementById('iniciarBtn').classList.remove('active');
            } else {
                iniciarCarrera();
            }
        }

        function finalizarCarrera() {
            endTime = new Date();
            clearInterval(timerInterval);
            clearInterval(intervalID);
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watchID);
            }
            mostrarResultados();
            const ritmoObjetivo = calcularRitmoObjetivo();
            const ritmoFinal = calcularRitmoPromedio();
            if (ritmoFinal <= ritmoObjetivo) {
                mostrarMensaje(`¡Felicidades! Alcanzaste tu ritmo objetivo. Ritmo Final: ${Math.floor(ritmoFinal)} min/km.`, 'achieved');
            } else {
                mostrarMensaje(`No alcanzaste tu ritmo objetivo. Ritmo Final: ${Math.floor(ritmoFinal)} min/km.`, 'not-achieved');
            }
        }

        function nuevaCarrera() {
            if (!carreraGuardada) {
                if (confirm("¿Quieres guardar la carrera antes de borrarla?")) {
                    guardarCarrera();
                } else {
                    resetearCarrera();
                }
            } else {
                resetearCarrera();
            }
        }

        function resetearCarrera() {
            document.getElementById('feedback').innerHTML = "";
            document.getElementById('ritmoObjetivo').innerHTML = "";
            document.getElementById('distanciaObjetivo').value = "0";
            document.getElementById('tiempoObjetivoHoras').value = "0";
            document.getElementById('tiempoObjetivoMinutos').value = "0";
            document.getElementById('nombreCarrera').value = "";
            initMap();
            clearInterval(timerInterval);
            clearInterval(intervalID);
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watchID);
            }
            distanciaRecorrida = 0;
            caloriasQuemadas = 0;
            isPaused = false;
            pausedDuration = 0;
            kmMarkers = [];
            document.getElementById('iniciarBtn').classList.remove('active');
            document.getElementById('pausarBtn').classList.remove('active');
            document.getElementById('pausarBtn').textContent = 'Pausar Carrera';
            carreraGuardada = false;
        }

        function updateLocation(position) {
            const { latitude, longitude } = position.coords;
            const currentLocation = [latitude, longitude];
            
            marker.setLatLng(currentLocation);
            path.addLatLng(currentLocation);
            map.setView(currentLocation);

            if (path.getLatLngs().length > 1) {
                const previousLocation = path.getLatLngs()[path.getLatLngs().length - 2];
                distanciaRecorrida += L.latLng(previousLocation).distanceTo(L.latLng(currentLocation)) / 1000;
                caloriasQuemadas = distanciaRecorrida * CALORIAS_POR_KM;
            }
            checkKmMarkers(currentLocation);
        }

        function checkKmMarkers(currentLocation) {
            const kmMark = Math.floor(distanciaRecorrida);
            if (kmMarkers.length < kmMark) {
                kmMarkers.push(currentLocation);
                utterance = new SpeechSynthesisUtterance(`¡Has completado ${kmMark} kilómetros!`);
                speechSynthesis.speak(utterance);
            }
        }

        function handleError(error) {
            console.error(`Error: ${error.message}`);
        }

        function updateFeedback() {
            const elapsedTime = new Date(new Date() - startTime - pausedDuration);
            const hours = elapsedTime.getUTCHours();
            const minutes = elapsedTime.getUTCMinutes();
            const seconds = elapsedTime.getUTCSeconds();
            const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('feedback').innerHTML = `Distancia: ${distanciaRecorrida.toFixed(2)} km<br> Tiempo: ${formattedTime}<br> Calorías: ${caloriasQuemadas.toFixed(2)} kcal<br> Ritmo Actual: ${calcularRitmoPromedio().toFixed(2)} min/km`;
        }

                function calcularRitmo() {
            const distancia = parseFloat(document.getElementById('distanciaObjetivo').value);
            const horas = parseInt(document.getElementById('tiempoObjetivoHoras').value);
            const minutos = parseInt(document.getElementById('tiempoObjetivoMinutos').value);
            const tiempoTotalMinutos = horas * 60 + minutos;
            
            if (distancia > 0 && tiempoTotalMinutos > 0) {
                const ritmo = tiempoTotalMinutos / distancia;
                document.getElementById('ritmoObjetivo').innerHTML = `Ritmo objetivo: ${ritmo.toFixed(2)} min/km`;
                document.getElementById('feedbackInicio').innerHTML = `Para alcanzar tu objetivo, debes mantener un ritmo de ${ritmo.toFixed(2)} min/km`;
            } else {
                document.getElementById('ritmoObjetivo').innerHTML = "Por favor, ingresa valores válidos para distancia y tiempo.";
            }
        }

        function calcularRitmoObjetivo() {
            const distancia = parseFloat(document.getElementById('distanciaObjetivo').value);
            const horas = parseInt(document.getElementById('tiempoObjetivoHoras').value);
            const minutos = parseInt(document.getElementById('tiempoObjetivoMinutos').value);
            const tiempoTotalMinutos = horas * 60 + minutos;
            return tiempoTotalMinutos / distancia;
        }

        function calcularRitmoPromedio() {
            const tiempoTotal = (new Date() - startTime - pausedDuration) / 60000; // Tiempo en minutos
            return tiempoTotal / distanciaRecorrida;
        }

        function checkRitmo() {
            const ritmoActual = calcularRitmoPromedio();
            const ritmoObjetivo = calcularRitmoObjetivo();
            if (ritmoActual > ritmoObjetivo * 1.1) {
                speak("Estás por debajo de tu ritmo objetivo. Intenta aumentar tu velocidad.");
                ritmoAlcanzado = false;
            } else if (ritmoActual < ritmoObjetivo * 0.9) {
                speak("Estás por encima de tu ritmo objetivo. Puedes reducir un poco tu velocidad.");
                ritmoAlcanzado = false;
            } else {
                speak("Buen trabajo. Estás manteniendo tu ritmo objetivo.");
                ritmoAlcanzado = true;
            }
        }

        function mostrarResultados() {
            const tiempoTotal = new Date(endTime - startTime - pausedDuration);
            const horas = tiempoTotal.getUTCHours();
            const minutos = tiempoTotal.getUTCMinutes();
            const segundos = tiempoTotal.getUTCSeconds();
            const ritmoPromedio = calcularRitmoPromedio();
            
            let resultados = `Distancia recorrida: ${distanciaRecorrida.toFixed(2)} km<br>`;
            resultados += `Tiempo total: ${horas}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}<br>`;
            resultados += `Ritmo promedio: ${ritmoPromedio.toFixed(2)} min/km<br>`;
            resultados += `Calorías quemadas: ${caloriasQuemadas.toFixed(2)} kcal`;
            
            document.getElementById('feedback').innerHTML = resultados;
        }

        function mostrarMensaje(mensaje, clase) {
            const feedbackElement = document.getElementById('feedback');
            feedbackElement.innerHTML += `<p class="${clase}">${mensaje}</p>`;
        }

        function mostrarRitmosPorKm() {
            let ritmos = "Ritmos por kilómetro:\n";
            for (let i = 0; i < kmMarkers.length; i++) {
                const kmTiempo = (i === 0) ? startTime : new Date(kmMarkers[i-1].timestamp);
                const ritmo = (kmMarkers[i].timestamp - kmTiempo) / 60000; // Tiempo en minutos
                ritmos += `Km ${i+1}: ${ritmo.toFixed(2)} min/km\n`;
            }
            alert(ritmos);
        }

        function exportarGPX() {
            let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
            gpx += '<gpx version="1.1" creator="RunnersPace Pro">\n';
            gpx += '  <trk>\n';
            gpx += '    <name>Mi carrera</name>\n';
            gpx += '    <trkseg>\n';

            path.getLatLngs().forEach(point => {
                gpx += `      <trkpt lat="${point.lat}" lon="${point.lng}"></trkpt>\n`;
            });

            gpx += '    </trkseg>\n';
            gpx += '  </trk>\n';
            gpx += '</gpx>';

            const blob = new Blob([gpx], {type: 'application/gpx+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'mi_carrera.gpx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function guardarCarrera() {
            const nombre = document.getElementById('nombreCarrera').value || `Carrera ${new Date().toLocaleString()}`;
            const carrera = {
                nombre: nombre,
                distancia: distanciaRecorrida,
                tiempo: new Date() - startTime - pausedDuration,
                calorias: caloriasQuemadas,
                ruta: path.getLatLngs()
            };
            
            let carreras = JSON.parse(localStorage.getItem('carreras')) || [];
            carreras.push(carrera);
            localStorage.setItem('carreras', JSON.stringify(carreras));
            
            alert('Carrera guardada exitosamente');
            carreraGuardada = true;
            actualizarCarrerasGuardadas();
        }

        function toggleCarrerasGuardadas() {
            const carrerasGuardadasDiv = document.getElementById('carrerasGuardadas');
            if (carrerasGuardadasDiv.style.display === 'none') {
                carrerasGuardadasDiv.style.display = 'block';
                actualizarCarrerasGuardadas();
            } else {
                carrerasGuardadasDiv.style.display = 'none';
            }
        }

        function actualizarCarrerasGuardadas() {
            const carrerasGuardadasDiv = document.getElementById('carrerasGuardadas');
            carrerasGuardadasDiv.innerHTML = '';
            
            const carreras = JSON.parse(localStorage.getItem('carreras')) || [];
            
            carreras.forEach((carrera, index) => {
                const carreraDiv = document.createElement('div');
                carreraDiv.className = 'carrera-guardada';
                carreraDiv.innerHTML = `
                    <h3>${carrera.nombre}</h3>
                    <p>Distancia: ${carrera.distancia.toFixed(2)} km</p>
                    <p>Tiempo: ${new Date(carrera.tiempo).toISOString().substr(11, 8)}</p>
                    <p>Calorías: ${carrera.calorias.toFixed(2)} kcal</p>
                    <button onclick="mostrarRutaGuardada(${index})">Mostrar Ruta</button>
                    <button onclick="eliminarCarreraGuardada(${index})">Eliminar</button>
                `;
                carrerasGuardadasDiv.appendChild(carreraDiv);
            });
        }

        function mostrarRutaGuardada(index) {
            const carreras = JSON.parse(localStorage.getItem('carreras')) || [];
            const carrera = carreras[index];
            
            // Limpiar el mapa actual
            path.setLatLngs([]);
            marker.setLatLng([0, 0]);
            
            // Dibujar la ruta guardada
            path.setLatLngs(carrera.ruta);
            
            // Centrar el mapa en la ruta
            const bounds = L.latLngBounds(carrera.ruta);
            map.fitBounds(bounds);
        }

        function eliminarCarreraGuardada(index) {
            if (confirm('¿Estás seguro de que quieres eliminar esta carrera?')) {
                let carreras = JSON.parse(localStorage.getItem('carreras')) || [];
                carreras.splice(index, 1);
                localStorage.setItem('carreras', JSON.stringify(carreras));
                actualizarCarrerasGuardadas();
            }
        }

        function mostrarEstadisticas() {
            const carreras = JSON.parse(localStorage.getItem('carreras')) || [];
            
            if (carreras.length === 0) {
                alert('No hay carreras guardadas para mostrar estadísticas.');
                return;
            }
            
            let distanciaTotal = 0;
            let tiempoTotal = 0;
            let caloriasTotal = 0;
            
            carreras.forEach(carrera => {
                distanciaTotal += carrera.distancia;
                tiempoTotal += carrera.tiempo;
                caloriasTotal += carrera.calorias;
            });
            
            const promedioDistancia = distanciaTotal / carreras.length;
            const promedioTiempo = tiempoTotal / carreras.length;
            const promedioCalorias = caloriasTotal / carreras.length;
            
            let mensaje = 'Estadísticas generales:\n\n';
            mensaje += `Número total de carreras: ${carreras.length}\n`;
            mensaje += `Distancia total recorrida: ${distanciaTotal.toFixed(2)} km\n`;
            mensaje += `Tiempo total: ${new Date(tiempoTotal).toISOString().substr(11, 8)}\n`;
            mensaje += `Calorías totales quemadas: ${caloriasTotal.toFixed(2)} kcal\n\n`;
            mensaje += 'Promedios:\n';
            mensaje += `Distancia promedio por carrera: ${promedioDistancia.toFixed(2)} km\n`;
            mensaje += `Tiempo promedio por carrera: ${new Date(promedioTiempo).toISOString().substr(11, 8)}\n`;
            mensaje += `Calorías promedio por carrera: ${promedioCalorias.toFixed(2)} kcal`;
            
            alert(mensaje);
        }

        function compartirEnRedes() {
            const mensaje = `¡Acabo de completar una carrera de ${distanciaRecorrida.toFixed(2)} km en ${new Date(endTime - startTime - pausedDuration).toISOString().substr(11, 8)}!`;
            
            // Aquí puedes agregar la lógica para compartir en diferentes redes sociales
            // Por ejemplo, para Twitter:
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        // Eventos de los botones
        document.getElementById('calcularRitmoBtn').addEventListener('click', calcularRitmo);
        document.getElementById('iniciarBtn').addEventListener('click', startCountdown);
        document.getElementById('pausarBtn').addEventListener('click', pausarReanudarCarrera);
        document.getElementById('finalizarBtn').addEventListener('click', finalizarCarrera);
        document.getElementById('nuevaCarreraBtn').addEventListener('click', nuevaCarrera);
        document.getElementById('mostrarRitmosBtn').addEventListener('click', mostrarRitmosPorKm);
        document.getElementById('exportarGPXBtn').addEventListener('click', exportarGPX);
        document.getElementById('guardarCarreraBtn').addEventListener('click', guardarCarrera);
        document.getElementById('toggleCarrerasGuardadasBtn').addEventListener('click', toggleCarrerasGuardadas);
        document.getElementById('mostrarEstadisticasBtn').addEventListener('click', mostrarEstadisticas);
        document.getElementById('compartirBtn').addEventListener('click', compartirEnRedes);

        // Inicialización
        initMap();
        actualizarCarrerasGuardadas();
   function tomarFoto() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(mediaStream => {
          const video = document.createElement('video');
          video.style.display = 'none';
          document.body.appendChild(video);
          video.srcObject = mediaStream;
          video.play();

          video.onloadedmetadata = () => {
            const button = document.createElement('button');
            button.textContent = 'Capturar Foto';
            button.style.display = 'block';
            document.body.appendChild(button);

            button.addEventListener('click', () => {
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const context = canvas.getContext('2d');
              context.drawImage(video, 0, 0, canvas.width, canvas.height);

              const photoContainer = document.getElementById('photoContainer');
              photoContainer.innerHTML = '';
              const img = document.createElement('img');
              img.src = canvas.toDataURL('image/jpeg');
              photoContainer.appendChild(img);

              video.pause();
              video.srcObject.getTracks().forEach(track => track.stop());
              document.body.removeChild(video);
              document.body.removeChild(button);
            });
          };
        })
        .catch(error => {
          console.error('Error al acceder a la cámara:', error);
          alert('Error al acceder a la cámara. Verifica que tienes permiso para acceder y que la cámara está disponible.');
        });
    }
    </script>
</body>
</html>
